#!/usr/bin/env python
# -*- Mode: python -*-
#
#----------------------------------------------------------------------
# Copyright (c) 2014 Raytheon BBN Technologies
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and/or hardware specification (the "Work") to
# deal in the Work without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Work, and to permit persons to whom the Work
# is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Work.
#
# THE WORK IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE WORK OR THE USE OR OTHER DEALINGS
# IN THE WORK.
#----------------------------------------------------------------------

#----------------------------------------------------------------------
#
# Notify users that their certificates are expiring.
#
#----------------------------------------------------------------------

import ConfigParser
import datetime
import logging
import optparse
import psycopg2
import psycopg2.extras
import smtplib
from email.mime.text import MIMEText
import sys

body = """Your GENI certificate is going to expire on %s.
To generate a new certificate, please go to:

   https://portal.geni.net/secure/home.php
"""

class Notifier:
    def __init__(self, conf_file):
        self.loadConfig(conf_file)

    def loadConfig(self, conf_file):
        config = ConfigParser.RawConfigParser()
        config.read(conf_file)
        sec = 'chapi'
        opts = ['portal_admin_email', 'portal_help_email', 'ch_from_email']
        for opt in opts:
            if config.has_option(sec, opt):
                setattr(self, opt, config.get(sec, opt))
            else:
                msg = 'config option %s not found in %s'
                msg = msg % (opt, conf_file)
                raise Exception(msg)

    def notify(self, address, expiration_date, logger):
        """Notify a member by email that their certificate expires on
        expiration_date.

        """
        logger.info('Email to %s, expiring on %s', address, expiration_date)
        from_addr = self.ch_from_email
        reply_to = self.portal_help_email
        msg = MIMEText(body % (expiration_date))
        msg['Subject'] = 'GENI certificate expiring on %s' % (expiration_date)
        msg['From'] = from_addr
        msg['To'] = address
        msg['Cc'] = reply_to
        msg['Reply-To'] = reply_to
        s = smtplib.SMTP('localhost')
        s.sendmail(from_addr, [address, reply_to], msg.as_string())
        s.quit()


def init_logging(options):
    level = logging.INFO
    if options.debug:
        level = logging.DEBUG
    logging.basicConfig(level=level)

def parse_args(argv):
    usage = '%s [options] --table TABLE' % (argv[0])
    parser = optparse.OptionParser(usage=usage)
    parser.add_option("--debug", action="store_true", default=False,
                       help="enable debugging output")
    parser.add_option("-d", "--database", default='portal',
                      help="database name")
    parser.add_option("--host", default='localhost',
                      help="database host")
    parser.add_option("-u", "--user", default='portal',
                      help="database user")
    days_help = "comma-separated list of expiration windows (e.g. '30,14,7')"
    parser.add_option("--days", default='30', help=days_help)
    parser.add_option("-c", "--conf", default='/etc/geni-chapi/chapi.ini',
                      help="chapi config file")
    options,args = parser.parse_args()
    return options,args

def alert_no_email(member_id, logger):
    """Alert an admin that no email address is available for this member."""
    logger.warn('No email address for member id %s', member_id)

def member_emails(conn, member_id, logger):
    """Look up the email addresses of the given member id.

    Note: will return a list of email addresses.
    """
    cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
    select_sql = ('SELECT value FROM ma_member_attribute'
                  + ' WHERE member_id = %s'
                  + ' AND name = %s')
    cur.execute(select_sql, (member_id, 'email_address'))
    rows = cur.fetchall()
    result = [row['value'] for row in rows]
    cur.close()
    return result

def notify_member(address, expiration_date, notifier, logger):
    """Notify a member by email that their certificate expires on
    expiration_date.

    """
    address = 'phelinek01.gpolab.bbn.com'
    logger.info('Email to %s, expiring on %s', address, expiration_date)
    notifier.notify(address, expiration_date, logger)

def notify_expiring(conn, ndays, notifier, logger):
    """Notify of expiring certificate n days away from today."""
    expire_day = datetime.date.today() + datetime.timedelta(ndays)
    cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
    select_sql = ('SELECT member_id FROM ma_outside_cert'
                  + ' WHERE date(expiration) = %s')
    cur.execute(select_sql, (expire_day,))
    rows = cur.fetchall()
    members = [row['member_id'] for row in rows]
    for member_id in members:
        logger.debug('%s\'s expiration: %s', member_id, expire_day)
        addrs = member_emails(conn, member_id, logger)
        if addrs:
            for addr in addrs:
                notify_member(addr, expire_day, notifier, logger)
        else:
            alert_no_email(member_id, logger)
    logger.debug('Notified %d members', len(members))
    cur.close()

def main(argv=None):
    if argv is None:
        argv = sys.argv
    try:
        options,args = parse_args(argv)
        init_logging(options)
    except Exception as e:
        sys.stderr.write(str(e) + "\n")
        return 1
    logger = logging.getLogger()
    try:
        # Convert days to integers as a validity check
        days = [int(d) for d in options.days.split(',')]
    except ValueError:
        msg = 'Invalid days parameter, must be integers\n'
        sys.stderr.write(msg)
        return 1
    logger.debug('days = %r' % (days))

    notifier = Notifier(options.conf)

    conn = psycopg2.connect(database=options.database,
                            user=options.user,
                            host=options.host)
    try:
        for day in days:
            notify_expiring(conn, day, notifier, logger)
    finally:
        conn.close()
    return 0

if __name__ == "__main__":
    sys.exit(main())
