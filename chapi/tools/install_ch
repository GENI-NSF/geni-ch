#!/bin/bash
tar pxfz chapi.tgz -C /usr/share/geni-ch
tar pxfz gcf-2.3.3.tar.gz -C /usr/share/geni-ch
mv /usr/share/geni-ch/gcf-2.3.3 /usr/share/geni-ch/gcf
tar xfz abac-0.1.5.tar.gz -C /usr/share/geni-ch

apt-get -y install libapache2-mod-fastcgi python-setuptools \
    python-dev python-m2crypto python-openssl python-flup nginx \
    python-dateutil python-openssl libxmlsec1 \
    xmlsec1 libxmlsec1-openssl libxmlsec1-dev libxml2-dev libxslt-dev \
    autoconf-archive automake g++ git-core libtool swig
easy_install flask Flask-XML-RPC python-dateutil blinker pika sqlalchemy lxml

cd /usr/share/geni-ch/abac-0.1.5/
./configure --prefix=/usr
make
make install

patch --backup -p0 /etc/apache2/mods-available/fastcgi.conf << EOF
--- fastcgi.conf	2013-09-03 15:51:58.606431660 -0400
+++ /etc/apache2/mods-available/fastcgi.conf	2013-09-06 08:46:20.682426270 -0400
@@ -2,4 +2,5 @@
   AddHandler fastcgi-script .fcgi
   #FastCgiWrapper /usr/lib/apache2/suexec
   FastCgiIpcDir /var/lib/apache2/fastcgi
+  FastCgiServer /usr/share/geni-ch/chapi/AMsoil/src/main.py -port 9003 -initial-env PYTHONPATH=/usr/share/geni-ch/chapi/chapi:/usr/share/geni-ch/chapi/chapi/tools:/usr/share/geni-ch/gcf/src
 </IfModule>
EOF

patch --backup -p0 /etc/apache2/mods-available/deflate.conf << EOF
--- /etc/apache2/mods-enabled/deflate.conf	2013-07-12 09:39:20.000000000 -0400
+++ chapi/deflate.conf	2013-09-03 16:12:34.894429239 -0400
@@ -1,6 +1,7 @@
 <IfModule mod_deflate.c>
           # these are known to be safe with MSIE 6
-          AddOutputFilterByType DEFLATE text/html text/plain text/xml
+#          AddOutputFilterByType DEFLATE text/html text/plain text/xml
+          AddOutputFilterByType DEFLATE text/plain
 
           # everything else may cause problems with MSIE 6
           AddOutputFilterByType DEFLATE text/css
EOF

chmod 644 /etc/apache2/sites-available/ch-ssl
patch --backup -p0 /etc/apache2/sites-available/ch-ssl << EOF
--- ch-ssl	2013-09-06 08:54:59.234460479 -0400
+++ /etc/apache2/sites-available/ch-ssl	2013-09-06 08:46:59.526437589 -0400
@@ -190,6 +190,17 @@
 	Include /usr/share/geni-ch/cs/apache2.conf
 	Include /usr/share/geni-ch/logging/apache2.conf
 
+        SSLOptions +ExportCertData
+        SSLCACertificateFile /usr/share/geni-ch/CA/cacert.pem
+        SSLVerifyClient require
+        SSLVerifyDepth 3
+        ScriptAlias /SA /usr/share/geni-ch/chapi/AMsoil/src/main.py
+        ScriptAlias /MA /usr/share/geni-ch/chapi/AMsoil/src/main.py 
+        ScriptAlias /CS /usr/share/geni-ch/chapi/AMsoil/src/main.py 
+        ScriptAlias /CH /usr/share/geni-ch/chapi/AMsoil/src/main.py 
+        ScriptAlias /LOG /usr/share/geni-ch/chapi/AMsoil/src/main.py 
+        ScriptAlias /PCGH /usr/share/geni-ch/chapi/AMsoil/src/main.py 
+
 </VirtualHost>
 
 # Catch-all default virtual host, so other CNAMEs to this IP are not
EOF


service apache2 restart
