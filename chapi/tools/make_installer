#!/bin/bash

# Exit on error
set -e
# Echo commands with variables expanded
set -x

# download abac and gcf
wget --output-document abac.tar.gz http://abac.deterlab.net/src/abac-0.1.5.tar.gz
#wget --output-document gcf.tar.gz --post-data "software=gcf-2.3.3.tar.gz&accept=I+have+read+and+accept+the+GPO+terms+of+service+and+disclaimer" http://software.geni.net/local-sw/real_download

# get the update-1.sql file and certs from the proto-ch tree
git clone git+ssh://trac.gpolab.bbn.com/srv/git/proto-ch.git
cd proto-ch
#git checkout sliverinfo
git checkout chapidev
cp sa/db/postgresql/update-1.sql ..
#cp -r sr ..
cp -r portal/www/portal ..
cp bin/migrate_assertions.sh ..
cp -r bin ..
cd ..

# clone chapi
git clone git+ssh://trac.gpolab.bbn.com/srv/git/chapi.git

# get gpo branch of local amsoil repo inside of chapi directory
cd chapi
git clone git+ssh://trac.gpolab.bbn.com/srv/git/amsoil.git
mv amsoil AMsoil
cd AMsoil
git checkout gpo

# fix up the amsoil directory
for pl in chrm chapiv1rpc sarm marm csrm logging pgch
do
    ln -s ../../../chapi/plugins/$pl src/plugins/$pl
done
chmod 777 deploy log

# tar up chapi and then the whole package
cd ../..
tar cfpz chapi.tgz chapi
cp chapi/chapi/tools/install_ch .
cp chapi/chapi/tools/install_db .
tar cfp chapi_installer.tar abac.tar.gz chapi.tgz install_ch install_db update-1.sql portal migrate_assertions.sh bin
